<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>helpers.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../config.rb.html">config.rb.example</a>
          <a class="source" href="helpers.html">helpers.rb</a>
          <a class="source" href="models.html">models.rb</a>
          <a class="source" href="zendesk.html">zendesk.rb</a>
          <a class="source" href="../sync.html">sync.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>helpers.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>These are the helper methods that do whatever terrible things Sinatra asks
of them. I&rsquo;m so so sorry, poor helpers</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">sync_trello</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="vi">@oboard</span> <span class="o">=</span> <span class="n">get_board</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="vi">@oboard</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">list</span><span class="o">|</span> <span class="n">get_list</span><span class="p">(</span><span class="n">list</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
    <span class="vi">@oboard</span><span class="o">.</span><span class="n">cards</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">card</span><span class="o">|</span> <span class="n">get_card</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_board</span><span class="p">(</span><span class="n">trello_id</span><span class="p">)</span>
    <span class="vi">@oboard</span> <span class="o">=</span> <span class="no">Trello</span><span class="o">::</span><span class="no">Board</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">trello_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">Board</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="n">trello_id</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
      <span class="no">Board</span><span class="o">.</span><span class="n">create</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="vi">@oboard</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">:trello_id</span> <span class="o">=&gt;</span> <span class="vi">@oboard</span><span class="o">.</span><span class="n">id</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="vi">@oboard</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_list</span><span class="p">(</span><span class="n">trello_id</span><span class="p">)</span>
    <span class="vi">@olist</span> <span class="o">=</span> <span class="no">Trello</span><span class="o">::</span><span class="no">List</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">trello_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">List</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="n">trello_id</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
      <span class="no">List</span><span class="o">.</span><span class="n">create</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="vi">@olist</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> 
        <span class="ss">:trello_id</span> <span class="o">=&gt;</span> <span class="n">trello_id</span><span class="p">,</span>
        <span class="ss">:board</span> <span class="o">=&gt;</span> <span class="no">Board</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="vi">@olist</span><span class="o">.</span><span class="n">board_id</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="vi">@olist</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_issue</span><span class="p">(</span><span class="n">zendesk_id</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="vi">@zticket</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ticket</span><span class="p">(</span><span class="n">zendesk_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:number</span><span class="p">,</span> <span class="n">zendesk_id</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="o">.</span><span class="n">create</span> <span class="ss">:number</span> <span class="o">=&gt;</span> <span class="n">zendesk_id</span><span class="p">,</span>
        <span class="ss">:oname</span> <span class="o">=&gt;</span> <span class="s2">&quot;#</span><span class="si">#{</span><span class="n">zendesk_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">Z</span><span class="o">.</span><span class="n">org_name</span><span class="p">(</span><span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;organization_id&quot;</span><span class="o">]</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;current_tags&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="ss">:list</span> <span class="o">=&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;status_id&quot;</span><span class="o">].</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">first</span><span class="p">),</span>
        <span class="ss">:board</span> <span class="o">=&gt;</span> <span class="no">Board</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="no">BOARD</span><span class="p">)</span>
      <span class="vi">@tcard</span> <span class="o">=</span> <span class="no">Trello</span><span class="o">::</span><span class="no">Card</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">issue</span><span class="o">.</span><span class="n">oname</span><span class="p">,</span> <span class="ss">:list_id</span> <span class="o">=&gt;</span> <span class="n">issue</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">trello_id</span><span class="p">)</span>
      <span class="n">issue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:trello_id</span> <span class="o">=&gt;</span> <span class="vi">@tcard</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:number</span><span class="p">,</span> <span class="n">zendesk_id</span><span class="p">)</span>
      <span class="n">issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:number</span><span class="p">,</span> <span class="n">zendesk_id</span><span class="p">)</span>
      <span class="vi">@ocard</span> <span class="o">=</span> <span class="no">Trello</span><span class="o">::</span><span class="no">Card</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">issue</span><span class="o">.</span><span class="n">trello_id</span><span class="p">)</span>
      <span class="vi">@lists</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;status_id&quot;</span><span class="o">].</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
      <span class="n">new_name</span> <span class="o">=</span> <span class="s2">&quot;#</span><span class="si">#{</span><span class="n">zendesk_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">Z</span><span class="o">.</span><span class="n">org_name</span><span class="p">(</span><span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;organization_id&quot;</span><span class="o">]</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;current_tags&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">unless</span> <span class="n">new_name</span> <span class="o">==</span> <span class="n">issue</span><span class="o">.</span><span class="n">oname</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">issue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:status</span> <span class="o">=&gt;</span> <span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;status_id&quot;</span><span class="o">]</span><span class="p">,</span>
                    <span class="ss">:oname</span> <span class="o">=&gt;</span> <span class="n">new_name</span><span class="p">)</span>
      <span class="vi">@ocard</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">issue</span><span class="o">.</span><span class="n">oname</span>
      <span class="k">unless</span> <span class="vi">@lists</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">issue</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">trello_id</span><span class="p">)</span>
        <span class="n">issue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:list</span> <span class="o">=&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="vi">@lists</span><span class="o">.</span><span class="n">first</span><span class="p">))</span>
        <span class="vi">@ocard</span><span class="o">.</span><span class="n">list_id</span> <span class="o">=</span> <span class="n">issue</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">trello_id</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="k">if</span> <span class="n">changed</span>
        <span class="vi">@ocard</span><span class="o">.</span><span class="n">save</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>not entirely sure why this is necessary</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="vi">@ocard</span> <span class="o">=</span> <span class="no">Trello</span><span class="o">::</span><span class="no">Card</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">issue</span><span class="o">.</span><span class="n">trello_id</span><span class="p">)</span>
      <span class="n">issue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:list</span> <span class="o">=&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">list_id</span><span class="p">))</span>

    <span class="k">end</span>
    <span class="k">return</span> <span class="n">issue</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_card</span><span class="p">(</span><span class="n">trello_id</span><span class="p">)</span>
    <span class="vi">@ocard</span> <span class="o">=</span> <span class="no">Trello</span><span class="o">::</span><span class="no">Card</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">trello_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="n">trello_id</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span> <span class="o">&amp;&amp;</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\#[0-9]+/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
      <span class="vi">@number</span> <span class="o">=</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\#[0-9]+/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
      <span class="vi">@zticket</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ticket</span><span class="p">(</span><span class="vi">@number</span><span class="p">)</span>
      <span class="k">if</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\#[0-9]+/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:number</span><span class="p">,</span> <span class="vi">@number</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
        <span class="no">Issue</span><span class="o">.</span><span class="n">create</span> <span class="ss">:number</span> <span class="o">=&gt;</span> <span class="vi">@number</span><span class="p">,</span>
          <span class="ss">:trello_id</span> <span class="o">=&gt;</span> <span class="n">trello_id</span><span class="p">,</span>
          <span class="ss">:timestamp</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span><span class="p">,</span>
          <span class="ss">:last_json</span> <span class="o">=&gt;</span> <span class="vi">@zticket</span><span class="p">,</span>
          <span class="ss">:oname</span> <span class="o">=&gt;</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
          <span class="ss">:zname</span> <span class="o">=&gt;</span> <span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;description&quot;</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;status_id&quot;</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:list</span> <span class="o">=&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">list_id</span><span class="p">),</span>
          <span class="ss">:board</span> <span class="o">=&gt;</span> <span class="no">Board</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">board_id</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">elsif</span> <span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="n">trello_id</span><span class="p">)</span>
      <span class="vi">@zticket</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ticket</span><span class="p">(</span><span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="n">trello_id</span><span class="p">)</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
      <span class="vi">@number</span> <span class="o">=</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\#[0-9]+/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">delete</span> <span class="s2">&quot;#&quot;</span>
      <span class="vi">@issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="n">trello_id</span><span class="p">)</span>
      <span class="vi">@issue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:oname</span> <span class="o">=&gt;</span> <span class="vi">@ocard</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
      <span class="ss">:timestamp</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="mi">60</span><span class="p">,</span>
      <span class="ss">:last_json</span> <span class="o">=&gt;</span> <span class="vi">@zticket</span><span class="p">,</span>
      <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;status_id&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:number</span> <span class="o">=&gt;</span> <span class="vi">@number</span> <span class="p">)</span>
      <span class="vi">@lists</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="vi">@zticket</span><span class="o">[</span><span class="s2">&quot;status_id&quot;</span><span class="o">].</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
      <span class="k">unless</span> <span class="vi">@lists</span><span class="o">.</span><span class="n">include?</span> <span class="vi">@issue</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">trello_id</span>
        <span class="vi">@issue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:list</span> <span class="o">=&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:trello_id</span><span class="p">,</span> <span class="vi">@lists</span><span class="o">.</span><span class="n">first</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="vi">@tcard</span> <span class="o">=</span> <span class="no">Trello</span><span class="o">::</span><span class="no">Card</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="vi">@issue</span><span class="o">.</span><span class="n">oname</span><span class="p">,</span> <span class="ss">:list_id</span> <span class="o">=&gt;</span> <span class="vi">@issue</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">trello_id</span><span class="p">)</span>
      <span class="vi">@issue</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:trello_id</span> <span class="o">=&gt;</span> <span class="vi">@tcard</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
